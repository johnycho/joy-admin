<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <title>게시글 수정</title>
  <th:block th:insert="~{fragments/import}"/>

  <!-- Toast UI Editor CSS -->
  <link href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" rel="stylesheet"/>
  <!-- Toast UI Editor JS -->
  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

  <style>
    #toastEditorWrapper {
      resize: vertical;
      overflow: auto;
      height: 500px;
      min-height: 500px;
      max-height: 2000px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
<th:block th:insert="~{fragments/heading}"/>
<th:block th:insert="~{fragments/loadingOverlay}"/>
<div class="row gy-4 g-xl-8">
  <div class="col-xxl-12">
    <div class="card">
      <div class="card-body d-flex flex-column">
        <h3 class="card-title fw-bolder text-black">게시글 수정</h3>
        <br>
        <form class="form-horizontal" id="blogPostForm" method="post" th:action="@{/blog/update}" th:object="${blogPost}">
          <div class="form-group">
            <label class="control-label col-sm-10" for="slug">slug:</label>
            <div class="col-sm-10">
              <input class="form-control" id="slug" name="slug" required th:value="*{slug}" type="text"/>
            </div>
          </div>
          <div class="form-group">
            <label class="control-label col-sm-10" for="title">title:</label>
            <div class="col-sm-10">
              <input class="form-control" id="title" name="title" required th:value="*{title}" type="text"/>
            </div>
          </div>
          <div class="form-group">
            <label class="control-label col-sm-10" for="authors">authors:</label>
            <div class="col-sm-10">
              <input class="form-control" id="authors" name="authors" required th:value="*{authors}" type="text"/>
            </div>
          </div>
          <div class="form-group">
            <label class="control-label col-sm-10" for="tags">tags:</label>
            <div class="col-sm-10">
              <input class="form-control" id="tags" name="tags" required th:value="*{tags}" type="text"/>
            </div>
          </div>
          <br>
          <div class="form-group">
            <label class="control-label col-sm-10" for="contents">contents:</label>
            <div class="col-sm-10">
              <div id="toastEditorWrapper">
                <div id="toastEditor"></div>
              </div>
              <input id="contents" name="contents" type="hidden"/>
            </div>
          </div>
          <div class="form-group">
            <input type="hidden" name="uuid" th:value="*{uuid}"/>
          </div>
          <br>
          <div class="form-group">
            <div class="col-sm-offset-1 col-sm-10">
              <button class="btn btn-success" th:formId="blogPostForm" th:onclick="|registerData(this.getAttribute('formId'))|">수정</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script th:inline="javascript">
  const editor = new toastui.Editor({
    el: document.querySelector('#toastEditor'),
    height: '100%',
    initialEditType: 'wysiwyg', // markdown
    hideModeSwitch: true, // 모드 전환 탭 숨김
    previewStyle: 'vertical', // tab
    language: 'ko',
  });

  const initialContent = /*<![CDATA[*/ [[${blogPost.contents}]] /*]]>*/;
  editor.setHTML(initialContent);

  // 일정 시간 뒤에 커서 이동 및 스크롤
  setTimeout(() => {
    const wwEditor = document.querySelector('.toastui-editor-ww-container .ProseMirror');
    if (wwEditor) {
      const range = document.createRange();
      const selection = window.getSelection();

      // 첫 텍스트 노드 찾기
      let firstTextNode = wwEditor.firstChild;
      if (firstTextNode && firstTextNode.nodeType === 1) {
        // 자식 노드 중 텍스트 노드 찾기
        firstTextNode = firstTextNode.firstChild;
      }

      if (firstTextNode) {
        range.setStart(firstTextNode, 0);
        range.collapse(true);
        selection.removeAllRanges();
        selection.addRange(range);
      }

      wwEditor.scrollTop = 0;
    }

    // 에디터 자체 포커스
    editor.focus();
  }, 300); // 필요시 300~500ms로 늘려도 OK

  function registerData(formId) {
    // 로딩 오버레이 표시
    document.getElementById('loadingOverlay').style.display = 'block';

    const form = document.getElementById(formId);
    const hiddenInput = document.getElementById('contents');
    hiddenInput.value = sanitizeHtmlForMdx(editor.getHTML());
    form.submit();
  }

  function sanitizeHtmlForMdx(html) {
    return html
    // Self-close void elements
    .replace(/<img([^>]*)>/gi, '<img$1 />')
    .replace(/<br([^>]*)>/gi, '<br$1 />')
    .replace(/<hr([^>]*)>/gi, '<hr$1 />')
    .replace(/<input([^>]*)>/gi, '<input$1 />')

    // Remove empty <p></p>
    .replace(/<p>\s*<\/p>/gi, '')

    // Convert <p>...</p> into "content  \n"
    .replace(/<p>(.*?)<\/p>/gis, (_, content) => `${content.trim()}  \n`)

    // Prevent block elements inside <p>
    .replace(/<p>(\s*<(div|section|article|ul|ol|h[1-6])[^>]*>.*?<\/\2>)\s*<\/p>/gis, '$1');
  }
</script>
</body>
</html>
